<div class="container">
    <div class="row">
        <div class="col">
            <h4>{{editing ? 'Editar '+ artFromDb.ic_nombre : 'Crear Producto o Servicio'}} </h4>
        </div>
        <div class="col-3 d-flex justify-content-end">
            <div class="btn-group" role="group" aria-label="Default button group">
                <button type="button" class="btn btn-outline-success" (click)="cancelar()"
                        title="Retornar a listado de productos y servicios">
                    <i class="fa fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col">
            <p-tabView [activeIndex]="activeTabIndex">
                <p-tabPanel header="Detalles">
                    <form [formGroup]="artForm" (ngSubmit)="procesaForm()">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Tipo:</label>
                                            <br>
                                            <p-selectButton [options]="tiposArt" formControlName="tipic_id"
                                                            optionLabel="label"
                                                            (onChange)="onTipoArtChange($event)"></p-selectButton>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Graba Iva:</label>
                                            <br>
                                            <p-selectButton [options]="ivas" formControlName="icdp_grabaiva"
                                                            (onChange)="onTipoIvaChange($event)"
                                                            optionLabel="label"></p-selectButton>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="codbarraInput">
                                        <span class="required">*</span>Código: <span *ngIf="!editing"
                                                                                     class="hand badge {{artCodAutomatic?'badge-primary':'badge-secondary'}} "
                                                                                     (click)="generarCodigoBarra()"
                                                                                     title="Seleccione esta opción si desea que el sistema genere el código para el producto o servicio"> Automático </span>
                                        <span *ngIf="editing" (click)="showModalEditBarcode()" class="badge badge-info" title="Editar el código de barra"> <i class="fa fa-pencil hand"> </i> </span>
                                    </label>
                                    <br>
                                    <input type="text" class="form-control" id="codbarraInput"
                                           aria-describedby="Código de barra"
                                           maxlength="80"
                                           autocomplete="off"
                                           (keydown.enter)="onEnterCodBarra($event)"
                                           placeholder="Ingrese el código del producto o servicio" name="ic_code"
                                           formControlName="ic_code"
                                           [ngClass]="{'is-invalid':submited && f.ic_code.errors}">
                                </div>

                                <div class="form-group">
                                    <label for="nombreInput">
                                        <span class="required">*</span>Nombre:</label>
                                    <br>
                                    <input type="text" class="form-control" id="nombreInput"
                                           aria-describedby="emailHelp"
                                           autocomplete="off"
                                           maxlength="150"
                                           (keydown.enter)="onEnterNombre($event)"
                                           (keyup)="$event.target.value=$event.target.value.toUpperCase()"
                                           placeholder="Ingrese el nombre del producto o servicio" name="ic_nombre"
                                           formControlName="ic_nombre"
                                           [ngClass]="{'is-invalid':submited && f.ic_nombre.errors}">
                                </div>

                                <div class="row" *ngIf="f.tipic_id && f.tipic_id.value.value===1">
                                    <div class="col">
                                        <div class="form-group">
                                            <label for="precioCompraInput">
                                                <span class="required">*</span>
                                                Precio Compra <span class="badge badge-light"
                                                                    *ngIf="f.icdp_grabaiva && f.icdp_grabaiva.value.value">(Sin Iva)</span>:</label>
                                            <br>
                                            <input type="text"
                                                   maxlength="10"
                                                   autocomplete="off"
                                                   class="form-control" id="precioCompraInput"
                                                   aria-describedby="emailHelp"
                                                   [pattern]="numbersPattern"
                                                   placeholder="Precio de compra" name="icdp_preciocompra"
                                                   (keyup)="onKeyupPrecioCompra($event)"
                                                   (keydown.enter)="onEnterPrecioCompra($event)"
                                                   formControlName="icdp_preciocompra"
                                                   [ngClass]="{'is-invalid':(submited && f.icdp_preciocompra.errors)||f.icdp_preciocompra.errors?.pattern}">
                                            <div *ngIf="f.icdp_preciocompra.errors?.pattern">
                                                <small class="text-danger">Valor incorrecto</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col" *ngIf="f.icdp_grabaiva && f.icdp_grabaiva.value.value">
                                        <div class="form-group">
                                            <label for="precioCompraInput">
                                                <span class="required">*</span>
                                                Precio Compra <span class="badge badge-light"> (Con Iva) </span>
                                                :</label>
                                            <br>
                                            <input type="text"
                                                   maxlength="10"
                                                   autocomplete="off"
                                                   class="form-control" id="precioCompraIvaInput"
                                                   aria-describedby="emailHelp"
                                                   placeholder="Precio de compra con iva" name="icdp_preciocompra_iva"
                                                   formControlName="icdp_preciocompra_iva">
                                        </div>
                                    </div>
                                </div>


                                <div class="form-group">
                                    <label for="precioVentaInput">
                                        <span class="required">*</span>Precio Venta: <span
                                            *ngIf="f.tipic_id && f.tipic_id.value.value===1"
                                            (click)="toggleAsistentePrecios()"
                                            class="hand badge {{isShowAsistPre?'badge-primary':'badge-secondary'}}"
                                            title="Muestra el asitente para establecimiento de precios de un producto">Asistente de precios</span>
                                    </label>
                                    <br>
                                    <input type="text"
                                           maxlength="10"
                                           autocomplete="off"
                                           class="form-control" id="precioVentaInput" aria-describedby="emailHelp"
                                           placeholder="Precio de venta" name="icdp_precioventa"
                                           (keydown.enter)="onEnterPrecioVenta($event)"
                                           formControlName="icdp_precioventa"
                                           [pattern]="numbersPattern"
                                           [ngClass]="{'is-invalid':(submited && f.icdp_precioventa.errors)||(f.icdp_precioventa.errors?.pattern)}">
                                    <div *ngIf="f.icdp_precioventa.errors?.pattern">
                                        <small class="text-danger">Valor incorrecto</small>
                                    </div>
                                </div>

                                <div class="card border-primary" *ngIf="isShowAsistPre">
                                    <small>
                                        Este asistente calcula el precio de venta, incrementando el precio de compra
                                        en el porcentaje ingresado.
                                    </small>
                                    <table class="table table-borderless table-sm">
                                        <thead>
                                        <tr>
                                            <th scope="col"><small>% Incremento </small></th>
                                            <th scope="col"><small>Utilidad </small></th>
                                            <th scope="col"><small>Precio Venta Sugerido </small></th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr>
                                            <td>
                                                <input type="text" (keyup)="onKeyupPorcentajeIncr($event)"
                                                       autocomplete="false"
                                                       formControlName="asist_pre_porc" id="porcIncAsistPre"
                                                       class="form-control form-control-sm">
                                            </td>
                                            <td>
                                                <input type="text" formControlName="asist_pre_util"
                                                       class="form-control form-control-sm">
                                            </td>
                                            <td>
                                                <input type="text" formControlName="asist_pre_prevsug"
                                                       class="form-control form-control-sm">
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                    <span class="hand badge badge-primary" (click)="toggleAsistentePrecios()"
                                          title="Cierra el asistente de precios">Cerrar</span>
                                </div>
                                <div class="form-group">
                                    <label for="ic_nota">Observación:</label>
                                    <br>
                                    <textarea pInputTextarea maxlength="1000" class="form-control"
                                              formControlName="ic_nota"
                                              name="ic_nota" id="ic_nota"
                                              rows="5"></textarea>
                                    <br>
                                </div>
                            </div>
                            <div class="col-md-4">

                                <div class="form-group">
                                    <label for="catic_id">Categoría:
                                        <span class="btn btn-sm btn-outline-secondary hand" title="Crear categoría" (click)="showModalCreaCateg()"> <i class="fa fa-plus-circle"></i> </span>
                                    </label>
                                    <br>
                                    <p-dropdown [options]="categorias" id="catic_id" formControlName="catic_id"
                                                filter="true"
                                                optionLabel="catic_nombre"
                                                inputId="catic_id"></p-dropdown>
                                </div>

                                <div class="form-group" *ngIf="f.tipic_id && f.tipic_id.value.value===1">
                                    <label for="icdp_proveedor">Proveedor:
                                        <!--
                                        <span class="btn btn-sm btn-outline-secondary hand" title="Agregar proveedor"> <i class="fa fa-plus-circle"></i> </span>
                                        -->
                                    </label>
                                    <br>
                                    <p-dropdown [options]="proveedores" id="icdp_proveedor"
                                                formControlName="icdp_proveedor"
                                                optionLabel="per_nombres" filter="true"
                                                inputId="icdp_proveedor"></p-dropdown>
                                </div>

                                <div class="form-group" *ngIf="f.tipic_id && f.tipic_id.value.value===1">
                                    <label for="icdp_fechacaducidad">Fecha de caducidad:</label>
                                    <br>
                                    <p-calendar formControlName="icdp_fechacaducidad" id="icdp_fechacaducidad"
                                                [showIcon]="true"
                                                [locale]="es" inputId="icdp_fechacaducidad"
                                                [monthNavigator]="true" [yearNavigator]="true" [minDate]="minimumDate"
                                                yearRange="2019:2050"
                                                dateFormat="dd/mm/yy"></p-calendar>
                                    <br>
                                </div>
                                <br>
                                <button type="button" class="btn btn-outline-success  btn-block"
                                        (click)="procesaForm()">
                                    <i class="fa fa-save"></i>
                                    Guardar
                                </button>
                                <button type="button" class="btn btn-outline-secondary  btn-block" (click)="cancelar()">
                                    <i class="fa fa-times"></i>
                                    Cancelar
                                </button>

                                <!--
                                 <br>
                                 <div class="row">
                                   <div class="col">
                                     <div class="text-center">
                                       <button type="submit" value="Guardar" class="btn btn-success" (click)="procesaForm()">
                                         <i class="pi pi-check"></i>
                                         Guardar
                                       </button>
                                       <br>
                                       <button type="button" value="Cancelar" class="btn btn-secondary" (click)="cancelar()">
                                         <i class="pi pi-times"></i>
                                         Cancelar
                                       </button>
                                     </div>
                                   </div>
                                 </div>
                                 -->
                            </div>
                        </div>
                    </form>


                </p-tabPanel>
                <p-tabPanel header="Stock" *ngIf="editing && artFromDb.tipic_id===1">
                    <h5> Stock para: {{artFromDb.ic_nombre}} </h5>
                    <div class="row">
                        <div class="col-8">
                            <div class="card border-primary">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item" *ngFor="let item of stock">
                                        <div class="row">
                                            <div class="col">
                                                {{item.sec_nombre}}
                                            </div>
                                            <div class="col">
                                                <input type="text" class="form form-control"
                                                       [(ngModel)]="item.ice_stock">
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col">
                            <button type="button" class="btn btn-outline-success  btn-block" (click)="guardarStock()">
                                <i class="fa fa-save"></i>
                                Guardar
                            </button>
                            <button type="button" class="btn btn-outline-secondary  btn-block" (click)="cancelar()">
                                <i class="fa fa-times"></i>
                                Cancelar
                            </button>
                        </div>
                    </div>
                </p-tabPanel>
            </p-tabView>
        </div>
    </div>

    <div class="modal" tabindex="-1" role="dialog" id="modalCreaCateg">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar categoría</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-3">
                            <label> Nombre: </label>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control auxNombreNuevaCatg"
                                   maxlength="50"
                                   (keyup)="$event.target.value=$event.target.value.toUpperCase()"
                                   [(ngModel)]="nombreNuevaCatg">
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" (click)="guardaCreaCatg()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" tabindex="-1" role="dialog" id="modalEditBarcode">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar código de barra</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-4">
                            <label> Codigo anterior: </label>
                        </div>
                        <div class="col">
                            <span> {{artFromDb.ic_code}} </span>
                        </div>
                    </div><div class="row">
                        <div class="col-4">
                            <label> Nuevo Código: </label>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control auxNuevoBarcode"
                                   aria-describedby="Código de barra"
                                   maxlength="80"
                                   autocomplete="off"
                                   [(ngModel)]="nuevoBarcode"
                                   placeholder="Ingrese el nuevo código">
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" (click)="guardaNuevoBarcode()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

</div>
